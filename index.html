<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Enhanced Swing Analyzer v12.1 ‚Äì Curated by BIPLAB BAWALI</title>
<meta name="theme-color" content="#1e3c72">
<link rel="icon" href="icon-192.png">
<link rel="manifest" href="manifest.json">

<!-- PDF libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
  --bg:#071028;
  --card:#ffffff;
  --accent:#1e3c72;
  --muted:#6b7280;
  --good:#16a34a;
  --bad:#dc2626;
  --neutral:#9ca3af;
  --accent2:#2a5298;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,Segoe UI,Arial;background:linear-gradient(180deg,var(--bg),#0f1724);color:#e6eef8;display:flex;justify-content:center;padding:18px;min-height:100vh}
.panel{width:100%;max-width:1100px;background:var(--card);color:#071026;border-radius:14px;padding:20px;box-shadow:0 12px 48px rgba(2,6,23,0.6)}
.header-row{display:flex;align-items:center;gap:14px;flex-wrap:wrap}
.title{font-size:20px;color:var(--accent);margin:0;font-weight:800}
.subtitle{font-size:13px;color:var(--muted);margin:0}
.controls{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap;align-items:center}
input[type=text]{flex:1;min-width:180px;padding:12px 14px;border-radius:8px;border:1px solid #e6eef8;font-size:14px}
select,button{padding:12px 16px;border-radius:8px;border:1px solid #e6eef8;background:transparent;cursor:pointer;min-height:44px;font-size:14px}
button.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:white;border:0;font-weight:700}
button.ghost{background:transparent;border:1px solid #e6eef8;color:#071026}
.meta{display:flex;align-items:center;gap:10px;margin-top:10px;flex-wrap:wrap}
.chip{background:#f3f6fb;padding:8px 12px;border-radius:999px;font-weight:700;color:#071026;font-size:13px}

.result{display:grid;grid-template-columns:1fr 360px;gap:16px;margin-top:14px}
.left{background:#f8fafc;padding:16px;border-radius:10px;color:#071026}
.right{background:#eef6ff;padding:16px;border-radius:10px;color:#04203a}
.label{font-size:12px;color:#6b7280;text-transform:uppercase;margin-bottom:6px}
.big{font-size:28px;font-weight:800;margin:0}
.sub{font-size:14px;color:#374151;margin-top:6px}
.pattern-box{background:#f7f9fc;padding:10px;border-radius:8px;border-left:4px solid #60a5fa;font-size:13px;color:#071026}
.score{display:flex;align-items:center;margin-top:8px}
.score-bar{height:20px;width:100%;background:#e6eef8;border-radius:999px;overflow:hidden;position:relative}
.score-fill{height:100%;text-align:center;font-weight:700;color:white;font-size:12px;line-height:20px;transition:width 0.8s ease}

.decision{font-size:16px;font-weight:800;padding:10px 12px;border-radius:8px;margin-top:10px;display:inline-block}
.strong-buy{background:#0f5132;color:#d1fae5}
.mod-buy{background:#14532d;color:#d1fae5}
.hold{background:#7c5e03;color:#fff7cc}
.mod-sell{background:#7f1d1d;color:#ffe4e6}
.strong-sell{background:#450a0a;color:#ffe4e6}

.advice{margin-top:10px;padding:12px;border-radius:8px;background:#f0fdf4;border-left:4px solid #10b981;color:#064e3b}
.ai-explain{margin-top:8px;padding:10px;border-radius:8px;background:#fff7ed;border-left:4px solid #f59e0b;color:#92400e}

.kv{display:flex;justify-content:space-between;gap:8px;margin-top:8px;padding:8px;background:#f9fafb;border-radius:6px}
.indicator-column{display:flex;flex-direction:column;gap:10px;margin-top:12px}
.ind-item{background:#f9fafb;padding:12px;border-radius:10px;border-left:6px solid #3b82f6;display:flex;flex-direction:column}
.ind-label{font-size:12px;color:#6b7280;text-transform:uppercase}
.ind-value{font-size:18px;font-weight:800;margin-top:6px}
.ind-note{font-size:12px;color:#6b7280;margin-top:6px}

.history-section{margin-top:14px;border-top:1px solid #e6eef8;padding-top:12px}
.history-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap;gap:8px}
.history-list{display:flex;flex-direction:column;gap:8px;max-height:240px;overflow:auto}
.history-item{background:#f3f6fb;padding:8px 10px;border-radius:8px;cursor:pointer;border:1px solid transparent;display:flex;justify-content:space-between;align-items:center}
.history-item:hover{background:#e6eef8;border-color:var(--accent)}
.signal-breakdown{background:#f9fafb;padding:10px;border-radius:8px;margin-top:8px;font-size:13px;color:#071026}

.footer{margin-top:14px;font-size:13px;color:#6b7280;text-align:center;padding-top:8px;border-top:1px solid #e6eef8}

.analyzing {
  position:relative;
  overflow:visible;
}
.analyzing::after{
  content:'Analyzing‚Ä¶';
  position:absolute;
  right:-6px;
  top:-42px;
  background:linear-gradient(90deg, rgba(14,56,120,0.12), rgba(14,56,120,0.18));
  color:var(--accent);
  padding:6px 10px;
  border-radius:999px;
  font-weight:700;
  animation: shimmer 1.6s infinite;
  box-shadow:0 6px 18px rgba(14,56,120,0.12);
}
@keyframes shimmer {
  0%{transform:translateY(0) scale(1);opacity:0.9}
  50%{transform:translateY(-3px) scale(1.02);opacity:1}
  100%{transform:translateY(0) scale(1);opacity:0.9}
}
@media(max-width:980px){
  .result{grid-template-columns:1fr}
  .indicator-column{flex-direction:row;flex-wrap:wrap}
  .ind-item{flex:1 1 48%}
}
</style>
</head>
<body>
  <div class="panel">
    <div class="header-row">
      <div>
        <h1 class="title">üéØ Enhanced Swing Analyzer ‚Äì v12.1</h1>
        <p class="subtitle">Curated by BIPLAB BAWALI</p>
      </div>
      <div style="flex:1"></div>
      <div class="chip" id="brandingChip">Curated By - BIPLAB BAWALI</div>
    </div>

    <div class="controls" role="toolbar">
      <input id="symbol" type="text" placeholder="Enter NSE symbol (RELIANCE, TCS)" value="RELIANCE" />
      <select id="lookback"><option value="180">6 months</option><option value="365" selected>12 months</option></select>
      <button id="analyzeBtn" class="primary">üî¨ Analyze Stock</button>
      <button id="watchBtn" class="ghost" title="Add to watchlist">‚≠ê Add Watch</button>
      <label style="display:flex;align-items:center;gap:6px"><input id="saveHistoryToggle" type="checkbox" checked> Save to History</label>
      <button id="exportPdfBtn" class="ghost">üìÑ Export PDF</button>
      <button id="exportHistoryPdfBtn" class="ghost">üìÑ Export History PDF</button>
      <button id="exportHistoryJsonBtn" class="ghost">üíæ Export History JSON</button>
    </div>

    <div class="meta">
      <div class="chip" id="status">Ready</div>
      <div style="flex:1"></div>
      <div style="font-size:13px;color:var(--muted)">Offline ‚Ä¢ Local Storage</div>
    </div>

    <div id="outputArea" class="result" style="display:none">
      <div class="left">
        <div class="label">Stock Information</div>
        <div class="big" id="outTicker">-</div>
        <div class="sub" id="outPrice">Price: -</div>

        <div class="label" style="margin-top:12px">Pattern Analysis</div>
        <div id="patternAnalysis" class="pattern-box">-</div>

        <div class="label" style="margin-top:12px">Signal Breakdown</div>
        <div id="signalBreakdown" class="signal-breakdown">No signals yet.</div>

        <div class="label" style="margin-top:12px">Signal Strength Score</div>
        <div class="score"><div class="score-bar"><div id="scoreFill" class="score-fill" style="width:0%;">0/100</div></div></div>

        <div class="label" style="margin-top:10px">Trading Decision</div>
        <div id="decisionBadge" class="decision hold">-</div>

        <div id="smartAdvice" class="advice" style="display:none"></div>
        <div id="aiExplain" class="ai-explain" style="display:none"></div>

        <div style="margin-top:12px">
          <div class="label">Risk Management</div>
          <div class="kv"><div>Stop Loss (Volatility Adjusted)</div><div id="stopLoss">-</div></div>
          <div class="kv"><div>Target 1</div><div id="target1">-</div></div>
          <div class="kv"><div>Target 2</div><div id="target2">-</div></div>
          <div class="kv"><div>Risk:Reward Ratio</div><div id="rrRatio">-</div></div>
          <div class="kv"><div>Position Size (2% risk)</div><div id="positionSize">-</div></div>
        </div>

        <div style="margin-top:12px" class="footer">Curated By - BIPLAB BAWALI</div>
      </div>

      <div class="right">
        <div class="label">Technical Indicators (Large Cards)</div>
        <div class="indicator-column" id="indicatorGrid">
          <!-- Large single-column indicator cards will be rendered here -->
        </div>

        <div style="margin-top:12px">
          <div class="label">Multi-Timeframe</div>
          <div id="weeklyAnalysis" style="margin-top:8px; padding:8px; background:#f9fafb; border-radius:6px; font-size:13px;"></div>
        </div>

        <div style="margin-top:12px">
          <div class="label">Volume</div>
          <div id="volumeAnalysis" style="margin-top:8px; padding:8px; background:#f9fafb; border-radius:6px; font-size:13px;"></div>
        </div>
      </div>
    </div>

    <div class="history-section">
      <div class="history-header">
        <div class="label">Search History (Local)</div>
        <div>
          <button id="clearHistoryBtn" class="ghost">üßπ Clear History</button>
        </div>
      </div>
      <div id="historyList" class="history-list"><div style="color:#9ca3af;font-style:italic;">No history yet.</div></div>
    </div>

    <div class="history-section" style="margin-top:12px">
      <div class="history-header">
        <div class="label">Watchlist (Local)</div>
        <div>
          <button id="clearWatchBtn" class="ghost">Clear Watchlist</button>
        </div>
      </div>
      <div id="watchlist" class="history-list"><div style="color:#9ca3af;font-style:italic;">No watchlist items.</div></div>
    </div>

    <div class="footer">¬© 2025 BIPLAB BAWALI ‚Äì Enhanced Swing Analyzer v12.1</div>
  </div>

<script>
/* ---------------------------
   Local storage keys & helpers
   --------------------------- */
const HISTORY_KEY = 'esa_history_local_v1';
const WATCH_KEY = 'esa_watchlist_local_v1';
function lsGet(key){ try{ return JSON.parse(localStorage.getItem(key)||'[]'); }catch{return [];} }
function lsSet(key,val){ try{ localStorage.setItem(key, JSON.stringify(val)); }catch(e){ console.warn('lsSet', e); } }

/* ---------------------------
   History & Watchlist logic
   --------------------------- */
function addHistoryRecord(symbol, meta = {}) {
  if(!document.getElementById('saveHistoryToggle').checked) return;
  const list = lsGet(HISTORY_KEY);
  const rec = { symbol, date: new Date().toISOString(), meta };
  list.unshift(rec);
  if(list.length > 1000) list.length = 1000;
  lsSet(HISTORY_KEY, list);
  renderHistory();
}

function getHistory(){ return lsGet(HISTORY_KEY); }
function clearHistory(){ localStorage.removeItem(HISTORY_KEY); renderHistory(); }

function renderHistory(){
  const el = document.getElementById('historyList');
  const list = getHistory();
  el.innerHTML = '';
  if(!list || !list.length){ el.innerHTML = '<div style="color:#9ca3af;font-style:italic;">No history yet.</div>'; return; }
  list.slice(0,200).forEach(item=>{
    const d = new Date(item.date);
    const row = document.createElement('div');
    row.className = 'history-item';
    row.innerHTML = `<div style="display:flex;flex-direction:column;align-items:flex-start"><strong>${item.symbol}</strong><div style="font-size:11px;color:#6b7280">${d.toLocaleString()}</div></div><div style="font-size:12px;color:#6b7280">‚ñ∂</div>`;
    row.addEventListener('click', ()=> { document.getElementById('symbol').value = item.symbol; runAnalysis(); });
    el.appendChild(row);
  });
}

function getWatchlist(){ return lsGet(WATCH_KEY); }
function renderWatchlist(){
  const el = document.getElementById('watchlist');
  const list = getWatchlist();
  el.innerHTML = '';
  if(!list || !list.length){ el.innerHTML = '<div style="color:#9ca3af;font-style:italic;">No watchlist items.</div>'; return; }
  list.slice(0,200).forEach(sym=>{
    const row = document.createElement('div');
    row.className = 'history-item';
    row.innerHTML = `<div style="display:flex;flex-direction:column;align-items:flex-start"><strong>${sym}</strong><div style="font-size:11px;color:#6b7280">‚òÖ Watch</div></div><div style="font-size:12px;color:#6b7280">‚ñ∂</div>`;
    row.addEventListener('click', ()=> { document.getElementById('symbol').value = sym; runAnalysis(); });
    el.appendChild(row);
  });
}

function toggleWatchLocal(symbol){
  if(!symbol) return alert('Enter a symbol first');
  const list = getWatchlist();
  const exists = list.includes(symbol);
  const newList = exists ? list.filter(x=>x!==symbol) : [symbol, ...list];
  lsSet(WATCH_KEY, newList);
  renderWatchlist();
  alert(exists ? `${symbol} removed from watchlist` : `${symbol} added to watchlist`);
}
function clearWatchlist(){ localStorage.removeItem(WATCH_KEY); renderWatchlist(); }

/* ---------------------------
   Export functions
   --------------------------- */
function exportHistoryJSON(){
  const data = getHistory();
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url;
  a.download = `esa_history_${new Date().toISOString().slice(0,10)}.json`;
  a.click(); URL.revokeObjectURL(url);
}

async function exportHistoryPDF(){
  const data = getHistory();
  if(!data || !data.length) return alert('No history to export');
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:'pt', format:'a4' });
  const pageW = doc.internal.pageSize.getWidth();
  let y = 40;
  doc.setFontSize(14); doc.text("Enhanced Swing Analyzer - History", 40, y); y += 20;
  doc.setFontSize(10); doc.text(`Exported: ${new Date().toLocaleString()}`, 40, y); y += 18;
  doc.setFontSize(10);
  for(let i=0;i<data.length;i++){
    const line = `${i+1}. ${data[i].symbol} ‚Äî ${new Date(data[i].date).toLocaleString()}`;
    const split = doc.splitTextToSize(line, pageW - 80);
    if(y + (split.length * 12) > doc.internal.pageSize.getHeight() - 40){ doc.addPage(); y = 40; }
    doc.text(split, 40, y); y += split.length * 12;
  }
  doc.save(`esa_history_${new Date().toISOString().slice(0,10)}.pdf`);
}

/* ---------------------------
   Utility & UI helpers
   --------------------------- */
function setStatus(s){ document.getElementById('status').textContent = s; }
function formatINR(x){ if(x===null||x===undefined||isNaN(x)) return '-'; return '‚Çπ' + Number(x).toFixed(2); }

/* ---------------------------
   Data fetcher (Yahoo via proxy)
   --------------------------- */
function allorigins(url) {
  return "https://dawn-recipe-ee4e.titir95biplab.workers.dev/?url=" + encodeURIComponent(url);
}

async function fetchYahoo(symbol, interval='1d', range='6mo'){
  const q = symbol.endsWith('.NS') ? symbol : symbol + '.NS';
  const url = `https://query1.finance.yahoo.com/v8/finance/chart/${q}?interval=${interval}&range=${range}`;
  const prox = allorigins(url);
  const res = await fetch(prox);
  if(!res.ok) throw new Error('Network error: ' + res.status);
  let txt = await res.text();
  if (txt.startsWith('<') || txt.startsWith('Edge')) {
    throw new Error('Proxy returned invalid response');
  }
  const j = JSON.parse(txt);
  if(!j.chart || !j.chart.result || !j.chart.result[0]) throw new Error('No data returned');
  const result = j.chart.result[0];
  const quote = result.indicators?.quote?.[0];
  if(!quote) throw new Error('No quote data');
  const timestamps = result.timestamp || [];
  const closes = [], highs = [], lows = [], volumes = [];
  for(let i=0;i<timestamps.length;i++){
    if(quote.close[i]!==null && quote.high[i]!==null && quote.low[i]!==null){
      closes.push(quote.close[i]); highs.push(quote.high[i]); lows.push(quote.low[i]); volumes.push(quote.volume[i]||0);
    }
  }
  return { closes, highs, lows, volumes, meta: result.meta || {} };
}

/* ---------------------------
   Indicator & analysis functions
   (kept intact from previous version)
   --------------------------- */
function EMA(series, period){ if(!series||series.length<period) return null; const k=2/(period+1); const ema=[series[0]]; for(let i=1;i<series.length;i++) ema.push(series[i]*k + ema[i-1]*(1-k)); return ema[ema.length-1]; }
function RSI(series, period=14){ if(!series||series.length<=period) return null; let gains=0,losses=0; for(let i=1;i<=period;i++){ const ch=series[i]-series[i-1]; if(ch>0) gains+=ch; else losses+=Math.abs(ch); } let avgG=gains/period, avgL=losses/period; for(let i=period+1;i<series.length;i++){ const ch=series[i]-series[i-1]; if(ch>0){ avgG=(avgG*(period-1)+ch)/period; avgL=(avgL*(period-1))/period; } else { avgG=(avgG*(period-1))/period; avgL=(avgL*(period-1)+Math.abs(ch))/period; } } if(avgL===0) return 100; const rs=avgG/avgL; return 100-(100/(1+rs)); }
function SMA(arr,period){ if(!arr||arr.length<period) return null; const sl=arr.slice(-period); return sl.reduce((a,b)=>a+b,0)/period; }
function Bollinger(series,period=20,mult=2){ if(!series||series.length<period) return null; const slice=series.slice(-period); const mean=slice.reduce((a,b)=>a+b,0)/period; const sq=slice.map(x=>Math.pow(x-mean,2)); const varr=sq.reduce((a,b)=>a+b,0)/period; const sd=Math.sqrt(varr); return {upper:mean+mult*sd,middle:mean,lower:mean-mult*sd}; }
function ATR(highs,lows,closes,period=14){ if(!closes||closes.length<period+1) return null; const trs=[]; for(let i=1;i<closes.length;i++){ const tr=Math.max(highs[i]-lows[i], Math.abs(highs[i]-closes[i-1]), Math.abs(lows[i]-closes[i-1])); trs.push(tr);} if(trs.length<period) return null; let atr=trs.slice(0,period).reduce((a,b)=>a+b,0)/period; for(let i=period;i<trs.length;i++) atr=(atr*(period-1)+trs[i])/period; return atr; }
function VWAP(prices,volumes,period=20){ if(!prices||prices.length<period) return null; const p=prices.slice(-period), v=volumes.slice(-period); const pv=p.map((x,i)=>x*v[i]); const pvSum=pv.reduce((a,b)=>a+b,0); const vSum=v.reduce((a,b)=>a+b,0); return vSum===0?null:pvSum/vSum; }
function MACD(series,short=12,long=26,signal=9){ if(!series||series.length<long+signal) return null; function emaArr(arr,per){ const k=2/(per+1); const e=[arr[0]]; for(let i=1;i<arr.length;i++) e.push(arr[i]*k+e[i-1]*(1-k)); return e;} const eShort=emaArr(series,short), eLong=emaArr(series,long); const macdLine=eShort.map((v,i)=>v-eLong[i]); if(macdLine.length<signal) return null; const sLine=emaArr(macdLine,signal); const hist=macdLine.map((v,i)=>v-sLine[i]); return {macd:macdLine[macdLine.length-1], signal:sLine[sLine.length-1], histogram: hist[hist.length-1]}; }
function Supertrend(highs,lows,closes,period=10,mult=3){ if(!closes||closes.length<period+1) return null; const atr=ATR(highs,lows,closes,period); if(!atr) return null; const hl2=(highs[highs.length-1]+lows[lows.length-1])/2; const upper=hl2+mult*atr, lower=hl2-mult*atr; const price=closes[closes.length-1]; return {upper, lower, trend: price>lower?'bullish':'bearish', value: price>lower?lower:upper}; }
function analyzeVolume(volumes,period=20){ if(!volumes||volumes.length<period) return null; const recent=volumes.slice(-period); const avg=recent.reduce((a,b)=>a+b,0)/period; const cur=volumes[volumes.length-1]; const prev=volumes[volumes.length-2]||cur; return {avgVolume:avg,currentVolume:cur,volumeTrend:cur>avg?'above-average':'below-average',volumeChange:((cur-prev)/Math.max(1,prev)*100).toFixed(2)}; }

function findSupportResistance(closes, highs, lows, period = 20) {
  if(!closes || closes.length < period) return {support: null, resistance: null};
  const recent = closes.slice(-period);
  const recentHighs = highs.slice(-period);
  const recentLows = lows.slice(-period);
  const pivotHighs = [], pivotLows = [];
  for(let i = 2; i < recent.length - 2; i++) {
    if(recentHighs[i] > recentHighs[i-1] && recentHighs[i] > recentHighs[i-2] &&
       recentHighs[i] > recentHighs[i+1] && recentHighs[i] > recentHighs[i+2]) {
      pivotHighs.push(recentHighs[i]);
    }
    if(recentLows[i] < recentLows[i-1] && recentLows[i] < recentLows[i-2] &&
       recentLows[i] < recentLows[i+1] && recentLows[i] < recentLows[i+2]) {
      pivotLows.push(recentLows[i]);
    }
  }
  const resistance = pivotHighs.length > 0 ? pivotHighs.reduce((a,b) => a+b, 0) / pivotHighs.length : null;
  const support = pivotLows.length > 0 ? pivotLows.reduce((a,b) => a+b, 0) / pivotLows.length : null;
  return { support, resistance, pivotHighs, pivotLows };
}

function calculateConfluence(ctx) {
  let bullishCount = 0, bearishCount = 0;
  if(ctx.rsi !== null && ctx.rsi < 30) bullishCount++;
  if(ctx.rsi !== null && ctx.rsi > 70) bearishCount++;
  if(ctx.ema50 !== null && ctx.ema200 !== null) {
    if(ctx.ema50 > ctx.ema200) bullishCount++;
    if(ctx.ema50 < ctx.ema200) bearishCount++;
  }
  if(ctx.macdHist !== null) {
    if(ctx.macdHist > 0) bullishCount++;
    if(ctx.macdHist < 0) bearishCount++;
  }
  if(ctx.supertrend?.trend === 'bullish') bullishCount++;
  if(ctx.supertrend?.trend === 'bearish') bearishCount++;
  if(ctx.vwap && ctx.price) {
    if(ctx.price > ctx.vwap) bullishCount++;
    if(ctx.price < ctx.vwap) bearishCount++;
  }
  if(ctx.weeklyBull === true) bullishCount++;
  if(ctx.weeklyBull === false) bearishCount++;
  const totalSignals = 6;
  const agreement = Math.max(bullishCount, bearishCount) / totalSignals;
  return {confluence: agreement, direction: bullishCount > bearishCount ? 'bullish' : 'bearish', bullishCount, bearishCount};
}

function detectPatterns(closes, highs, lows){
  if(!closes||closes.length<20) return "Not enough data for pattern detection.";
  const price = closes[closes.length-1];
  const prev = closes.slice(-10);
  const messages=[];
  const max1 = Math.max(...prev.slice(0,5));
  const max2 = Math.max(...prev.slice(5));
  const min1 = Math.min(...prev.slice(0,5));
  const min2 = Math.min(...prev.slice(5));
  if(Math.abs(max1-max2)/Math.max(1,max1) < 0.02 && price < Math.min(max1,max2)) messages.push("‚ö†Ô∏è Possible Double Top ‚Äì bearish reversal");
  if(Math.abs(min1-min2)/Math.max(1,min1) < 0.02 && price > Math.max(min1,min2)) messages.push("üíé Possible Double Bottom ‚Äì bullish reversal");
  const trendHigh = highs[highs.length-1] - highs[Math.max(0, highs.length-5)];
  const trendLow = lows[lows.length-1] - lows[Math.max(0, lows.length-5)];
  if(trendHigh<0 && trendLow>0) messages.push("üî∫ Contracting range ‚Äì potential triangle breakout");
  const recentHigh = Math.max(...prev);
  const recentLow = Math.min(...prev);
  if(price>recentHigh) messages.push("üöÄ Breakout above recent resistance ‚Äì bullish continuation");
  if(price<recentLow) messages.push("üìâ Breakdown below recent support ‚Äì bearish continuation");
  const sr = findSupportResistance(closes, highs, lows, 30);
  if(sr.support !== null) {
    const distToSupport = ((price - sr.support) / price * 100);
    if(Math.abs(distToSupport) < 2) messages.push(`üîç Price near support level ‚Çπ${sr.support.toFixed(2)} (${distToSupport.toFixed(1)}%)`);
  }
  if(sr.resistance !== null) {
    const distToResistance = ((price - sr.resistance) / price * 100);
    if(Math.abs(distToResistance) < 2) messages.push(`üîç Price near resistance level ‚Çπ${sr.resistance.toFixed(2)} (${distToResistance.toFixed(1)}%)`);
  }
  if(prev.length >= 9) {
    const leftShoulder = Math.max(...prev.slice(0,3));
    const head = Math.max(...prev.slice(3,6));
    const rightShoulder = Math.max(...prev.slice(6,9));
    if(head > leftShoulder * 1.02 && head > rightShoulder * 1.02 && Math.abs(leftShoulder - rightShoulder) / leftShoulder < 0.03) {
      messages.push("üë§ Potential Head & Shoulders pattern - bearish reversal");
    }
  }
  return messages.length? messages.join("<br>") : "No significant pattern detected.";
}

function computeScoreAndDecision(ctx){
  let score=50; const signals=[];
  const volatilityMultiplier = ctx.atr && ctx.price ? (ctx.atr / ctx.price > 0.03 ? 0.8 : 1.2) : 1;
  const w={trend: Math.round(20 * volatilityMultiplier), momentum: 15, rsi: 15, volatility: 12, support: 10, volume: Math.round(8 * (ctx.volume?.volumeTrend === 'above-average' ? 1.5 : 1)), vwap: 7, weekly: Math.round(13 * volatilityMultiplier)};
  if(ctx.ema50!==null && ctx.ema200!==null){
    if(ctx.ema50>ctx.ema200*1.01){ score+=w.trend; signals.push({text:'EMA50 > EMA200 (Bullish structure)',type:'bullish',strength:'strong'}); }
    else if(ctx.ema50<ctx.ema200*0.99){ score-=w.trend; signals.push({text:'EMA50 < EMA200 (Bearish structure)',type:'bearish',strength:'strong'}); }
    else signals.push({text:'EMA50 ‚âà EMA200 (Consolidation)',type:'neutral',strength:'weak'});
  }
  if(ctx.rsi!==null){
    if(ctx.rsi<30){ score+=w.rsi; signals.push({text:`RSI ${ctx.rsi.toFixed(1)} (Oversold)`,type:'bullish',strength:'strong'}); }
    else if(ctx.rsi>70){ score-=w.rsi; signals.push({text:`RSI ${ctx.rsi.toFixed(1)} (Overbought)`,type:'bearish',strength:'strong'}); }
    else if(ctx.rsi>50){ score+=3; signals.push({text:`RSI ${ctx.rsi.toFixed(1)} (Bullish zone)`,type:'bullish',strength:'weak'}); }
    else { score-=3; signals.push({text:`RSI ${ctx.rsi.toFixed(1)} (Bearish zone)`,type:'bearish',strength:'weak'}); }
  }
  if(ctx.macdHist!==null){
    const s = Math.abs(ctx.macdHist)>5?'strong':'moderate';
    if(ctx.macdHist>0){ score+=w.momentum*(s==='strong'?1:0.6); signals.push({text:'MACD histogram positive',type:'bullish',strength:s}); }
    else { score-=w.momentum*(s==='strong'?1:0.6); signals.push({text:'MACD histogram negative',type:'bearish',strength:s}); }
  }
  if(ctx.bb!==null && ctx.price!==null){
    if(ctx.price<ctx.bb.lower){ score+=w.volatility; signals.push({text:'Price below lower BB (Mean reversion)',type:'bullish',strength:'moderate'}); }
    else if(ctx.price>ctx.bb.upper){ score-=w.volatility; signals.push({text:'Price above upper BB (Over-extension)',type:'bearish',strength:'moderate'}); }
    else signals.push({text:'Price within BB range',type:'neutral',strength:'weak'});
  }
  if(ctx.supertrend!==null){
    if(ctx.supertrend.trend==='bullish'){ score+=w.support; signals.push({text:'Supertrend bullish',type:'bullish',strength:'moderate'}); }
    else { score-=w.support; signals.push({text:'Supertrend bearish',type:'bearish',strength:'moderate'}); }
  }
  if(ctx.vwap!==null && ctx.price!==null){
    const diff=((ctx.price-ctx.vwap)/ctx.vwap*100);
    if(diff>1){ score+=w.vwap; signals.push({text:`Price ${diff.toFixed(1)}% above VWAP`,type:'bullish',strength:'weak'}); }
    else if(diff<-1){ score-=w.vwap; signals.push({text:`Price ${Math.abs(diff).toFixed(1)}% below VWAP`,type:'bearish',strength:'weak'}); }
    else signals.push({text:'Price near VWAP',type:'neutral',strength:'weak'});
  }
  if(ctx.volume!==null){
    if(ctx.volume.volumeTrend==='above-average'){ 
      if(score>50) score+=w.volume; 
      else score-=w.volume*0.5; 
      signals.push({text:`Volume ${ctx.volume.volumeTrend}`,type: score>50?'bullish':'bearish',strength:'moderate'}); 
    }
    else { signals.push({text:'Volume below average',type:'neutral',strength:'weak'}); score*=0.95; }
  }
  if(ctx.weeklyBull!==null){ 
    if(ctx.weeklyBull===true){ score+=w.weekly; signals.push({text:'Weekly trend bullish',type:'bullish',strength:'strong'}); } 
    else { score-=w.weekly; signals.push({text:'Weekly trend bearish',type:'bearish',strength:'strong'}); } 
  }
  if(ctx.patternBias && typeof ctx.patternBias==='number' && ctx.patternBias!==0){
    score += ctx.patternBias;
    signals.push({text:`Pattern bias ${ctx.patternBias>0?'+':''}${ctx.patternBias}`, type: ctx.patternBias>0?'bullish':'bearish', strength:'moderate'});
  }
  const confluence = calculateConfluence(ctx);
  if(confluence.confluence > 0.66) {
    const boost = 5;
    if(confluence.direction === 'bullish' && score > 50) score += boost;
    if(confluence.direction === 'bearish' && score < 50) score -= boost;
    signals.push({text: `High confluence: ${confluence.bullishCount} bullish vs ${confluence.bearishCount} bearish signals`, type: confluence.direction, strength: 'strong'});
  }
  score = Math.max(0, Math.min(100, Math.round(score)));
  let decisionLabel = 'HOLD';
  if(score>=75) decisionLabel='STRONG BUY';
  else if(score>=60) decisionLabel='MODERATE BUY';
  else if(score<=25) decisionLabel='STRONG SELL';
  else if(score<=40) decisionLabel='MODERATE SELL';
  else decisionLabel='HOLD';
  return {score, decisionLabel, signals, confluence};
}

function generateAIExplanation(ctx, decision) {
  const parts = [];
  if(ctx.patternSummary) parts.push(`Pattern detected: ${ctx.patternSummary}.`);
  if(ctx.confluence) parts.push(`Confluence analysis shows ${ctx.confluence.bullishCount} bullish and ${ctx.confluence.bearishCount} bearish signals agreeing.`);
  if(ctx.rsi!==null){
    if(ctx.rsi<35) parts.push(`RSI is low (${ctx.rsi.toFixed(0)}), indicating buying exhaustion/support.`);
    else if(ctx.rsi>65) parts.push(`RSI is elevated (${ctx.rsi.toFixed(0)}), indicating overbought pressure.`);
    else parts.push(`RSI at ${ctx.rsi.toFixed(0)} shows neutral momentum.`);
  }
  if(ctx.macdHist!==null){
    if(ctx.macdHist>0) parts.push(`MACD histogram positive (${ctx.macdHist.toFixed(3)}), momentum favors upside.`);
    else parts.push(`MACD histogram negative (${ctx.macdHist.toFixed(3)}), momentum favors downside.`);
  }
  if(ctx.ema50!==null && ctx.ema200!==null){
    if(ctx.ema50>ctx.ema200) parts.push('EMA50 > EMA200 ‚Äì structural trend is bullish.');
    else parts.push('EMA50 < EMA200 ‚Äì structural trend is bearish.');
  }
  if(ctx.volume && ctx.volume.volumeTrend) parts.push(`Volume is ${ctx.volume.volumeTrend}, which ${ctx.volume.volumeTrend==='above-average'?'supports':'weakens'} the signal.`);
  if(ctx.volatilityRegime) parts.push(`Market is in ${ctx.volatilityRegime} volatility regime.`);
  parts.push(`Final verdict: ${decision}.`);
  const conf = ctx.score>=75?0.9:ctx.score>=60?0.75:ctx.score<=25?0.9:ctx.score<=40?0.6:0.5;
  parts.push(`Confidence: ${(conf*100).toFixed(0)}% based on indicator confluence.`);
  return { text: parts.join(' '), confidence: conf };
}

/* ---------------------------
   Color helpers (ensure present)
   --------------------------- */
function colorForRSI(rsi){
  if(rsi === null || isNaN(rsi)) return { color: 'var(--neutral)' };
  if(rsi > 60) return { color: 'var(--good)' };
  if(rsi < 40) return { color: 'var(--bad)' };
  return { color: 'var(--neutral)' };
}
function colorForMACD(hist){
  if(hist === null || isNaN(hist)) return { color: 'var(--neutral)' };
  return hist > 0 ? { color: 'var(--good)' } : { color: 'var(--bad)' };
}

/* ---------------------------
   Main UI actions & runAnalysis
   --------------------------- */
document.addEventListener('DOMContentLoaded', ()=>{
  document.getElementById('analyzeBtn').addEventListener('click', runAnalysis);
  document.getElementById('watchBtn').addEventListener('click', async ()=> { const s=document.getElementById('symbol').value.trim().toUpperCase(); toggleWatchLocal(s); });
  document.getElementById('exportPdfBtn').addEventListener('click', exportCurrentToPDF);
  document.getElementById('exportHistoryJsonBtn').addEventListener('click', exportHistoryJSON);
  document.getElementById('exportHistoryPdfBtn').addEventListener('click', exportHistoryPDF);
  document.getElementById('clearHistoryBtn').addEventListener('click', ()=>{ if(confirm('Clear saved history?')) clearHistory(); });
  document.getElementById('clearWatchBtn').addEventListener('click', ()=>{ if(confirm('Clear watchlist?')) clearWatchlist(); });
  document.getElementById('symbol').addEventListener('keypress', (e)=> { if(e.key==='Enter') runAnalysis(); });

  // initial render
  renderHistory();
  renderWatchlist();

  // register service worker (best-effort)
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('service-worker.js').catch(()=>console.warn('SW registration failed'));
  }
});

async function runAnalysis(){
  const symbolRaw = document.getElementById('symbol').value.trim().toUpperCase();
  if(!symbolRaw) return alert('Please enter a stock symbol (e.g., RELIANCE)');
  const lookback = document.getElementById('lookback').value;
  const range = lookback === '365' ? '1y' : '6mo';
  const ticker = symbolRaw.endsWith('.NS') ? symbolRaw.slice(0,-3) : symbolRaw;

  const analyzeBtn = document.getElementById('analyzeBtn');
  analyzeBtn.classList.add('analyzing');
  analyzeBtn.disabled = true;

  setStatus('Fetching data...');
  document.getElementById('outputArea').style.display = 'none';

  try{
    const [daily, weekly] = await Promise.all([ fetchYahoo(symbolRaw, '1d', range), fetchYahoo(symbolRaw, '1wk', '2y') ]);
    setStatus('Calculating indicators... (1/3)');
    
    const { closes, highs, lows, volumes } = daily;
    if(!closes || closes.length < 50) throw new Error('Insufficient data (need 50+ days): ' + (closes?.length || 0));
    
    const price = closes[closes.length-1];
    const prevPrice = closes[closes.length-2] || price;
    const change = price - prevPrice;
    const changePct = (change / Math.max(0.0001, prevPrice)) * 100;

    const rsi = RSI(closes,14);
    const ema50 = EMA(closes,50);
    const ema200 = EMA(closes,200);
    const macd = MACD(closes,12,26,9);
    const bb = Bollinger(closes,20,2);
    const vwap = VWAP(closes,volumes,20);
    const atr = ATR(highs,lows,closes,14);
    const supertrend = Supertrend(highs,lows,closes,10,3);
    const volumeData = analyzeVolume(volumes,20);

    setStatus('Analyzing patterns... (2/3)');

    const weeklyCloses = weekly.closes || [];
    const weeklyEma50 = weeklyCloses.length>=50?EMA(weeklyCloses,50):null;
    const weeklyEma200 = weeklyCloses.length>=200?EMA(weeklyCloses,200):null;
    const weeklyBull = (weeklyEma50 && weeklyEma200) ? weeklyEma50 > weeklyEma200 : null;

    const patternText = detectPatterns(closes, highs, lows);
    let patternBias = 0, patternSummary = '';
    if(patternText.includes('Double Top')){ patternBias -= 15; patternSummary = 'Double Top (bearish)'; }
    if(patternText.includes('Double Bottom')){ patternBias += 15; patternSummary = 'Double Bottom (bullish)'; }
    if(patternText.includes('Breakout above')){ patternBias += 10; patternSummary = patternSummary || 'Breakout above resistance'; }
    if(patternText.includes('Breakdown below')){ patternBias -= 10; patternSummary = patternSummary || 'Breakdown below support'; }
    if(patternText.includes('Contracting range')){ patternSummary = patternSummary || 'Contracting range (watch breakout)'; }
    if(patternText.includes('Head & Shoulders')){ patternBias -= 12; patternSummary = patternSummary || 'Head & Shoulders (bearish)'; }

    setStatus('Computing signals... (3/3)');

    const volatilityRatio = atr / price;
    const volatilityRegime = volatilityRatio > 0.03 ? 'high' : volatilityRatio < 0.015 ? 'low' : 'normal';

    const ctx = { price, rsi, ema50, ema200, macdHist: macd?.histogram, bb, vwap, atr, supertrend, volume: volumeData, weeklyBull, patternBias, patternSummary, volatilityRegime};
    const { score, decisionLabel, signals, confluence } = computeScoreAndDecision(ctx);
    ctx.score = score;
    ctx.confluence = confluence;

    const isBuy = decisionLabel.includes('BUY'), isSell = decisionLabel.includes('SELL');
    const atrValue = atr || price * 0.02;
    const isHighVol = volatilityRatio > 0.03;
    const stopMultiplier = isHighVol ? 2.0 : 1.5;
    const target1Multiplier = isHighVol ? 2.5 : 2.0;
    const target2Multiplier = isHighVol ? 5.0 : 4.0;

    const stopLoss = isBuy ? price - stopMultiplier * atrValue : isSell ? price + stopMultiplier * atrValue : null;
    const target1 = isBuy ? price + target1Multiplier * atrValue : isSell ? price - target1Multiplier * atrValue : null;
    const target2 = isBuy ? price + target2Multiplier * atrValue : isSell ? price - target2Multiplier * atrValue : null;
    const rrRatio = stopLoss ? Math.abs((target1 - price) / (stopLoss - price)).toFixed(2) : null;
    const accountRisk = 0.02;
    const stopDistance = stopLoss ? Math.abs(price - stopLoss) : 0;
    const positionSize = stopDistance > 0 ? ((accountRisk / (stopDistance / price)) * 100).toFixed(2) : null;

    // Populate UI
    document.getElementById('outTicker').textContent = ticker + ' (NSE)';
    document.getElementById('outPrice').textContent = `Price: ${formatINR(price)} ${change>=0?'‚ñ≤':'‚ñº'} ${formatINR(Math.abs(change))} (${changePct>=0?'+':''}${changePct.toFixed(2)}%)`;
    document.getElementById('outPrice').style.color = change>=0? 'var(--good)' : 'var(--bad)';
    document.getElementById('patternAnalysis').innerHTML = patternText + (patternSummary ? `<div style="margin-top:6px;font-size:12px;color:#6b7280">Bias: ${patternSummary}</div>` : '');

    const scoreFill = document.getElementById('scoreFill');
    scoreFill.style.width = score + '%';
    scoreFill.textContent = score + '/100';
    if(score >= 60) scoreFill.style.background = 'linear-gradient(90deg,var(--good),#10b981)';
    else if(score <= 40) scoreFill.style.background = 'linear-gradient(90deg,var(--bad),#ef4444)';
    else scoreFill.style.background = 'linear-gradient(90deg,#d97706,#f59e0b)';

    const badge = document.getElementById('decisionBadge');
    badge.textContent = decisionLabel; badge.className = 'decision';
    if(decisionLabel==='STRONG BUY') badge.classList.add('strong-buy');
    else if(decisionLabel==='MODERATE BUY') badge.classList.add('mod-buy');
    else if(decisionLabel==='MODERATE SELL') badge.classList.add('mod-sell');
    else if(decisionLabel==='STRONG SELL') badge.classList.add('strong-sell');
    else badge.classList.add('hold');

    document.getElementById('smartAdvice').style.display = 'block';
    const adviceText = decisionLabel.includes('BUY') ? `üìà Suggestion: Consider BUY near ${formatINR(price)}. Stop-loss: ${formatINR(stopLoss)}. Targets: ${formatINR(target1)} and ${formatINR(target2)}.` :
                       decisionLabel.includes('SELL') ? `üìâ Suggestion: Consider SELL near ${formatINR(price)}. Stop-loss: ${formatINR(stopLoss)}. Targets: ${formatINR(target1)} and ${formatINR(target2)}.` :
                       `‚öñÔ∏è Hold / Observe.`;
    document.getElementById('smartAdvice').innerHTML = adviceText + `<div style="margin-top:6px;font-size:12px;color:#6b7280">Confidence: ${(Math.max(0.35, Math.min(0.95, (score/100))) * 100).toFixed(0)}%</div>`;

    document.getElementById('aiExplain').style.display = 'block';
    document.getElementById('aiExplain').innerHTML = generateAIExplanation(ctx, decisionLabel).text;

    document.getElementById('stopLoss').textContent = stopLoss ? formatINR(stopLoss) : '-';
    document.getElementById('target1').textContent = target1 ? formatINR(target1) : '-';
    document.getElementById('target2').textContent = target2 ? formatINR(target2) : '-';
    document.getElementById('rrRatio').textContent = rrRatio || '-';
    document.getElementById('positionSize').textContent = positionSize ? `${positionSize}%` : '-';

    // Render Large single-column indicator cards (exact values + colors)
    const ig = document.getElementById('indicatorGrid');
    ig.innerHTML = '';

    const indFull = [
      { label: 'RSI (14)', value: rsi ? rsi.toFixed(1) : '-', color: colorForRSI(rsi).color, note: rsi? (rsi>60?'Overbought':(rsi<40?'Oversold':'Neutral')) : '' },

      { label: 'EMA 50', value: ema50 ? formatINR(ema50) : '-', color: (ema50 && ema200) ? (ema50 > ema200 ? 'var(--good)' : 'var(--bad)') : 'var(--neutral)', note: ema50 && ema200 ? (ema50>ema200?'Bullish':'Bearish') : '' },

      { label: 'EMA 200', value: ema200 ? formatINR(ema200) : '-', color: (ema50 && ema200) ? (ema50 > ema200 ? 'var(--good)' : 'var(--bad)') : 'var(--neutral)' },

      { label: 'MACD Histogram', value: macd?.histogram ? macd.histogram.toFixed(3) : '-', color: colorForMACD(macd?.histogram).color },

      { label: 'BB Upper (20,2)', value: bb ? formatINR(bb.upper) : '-', color: 'var(--neutral)' },
      { label: 'BB Middle', value: bb ? formatINR(bb.middle) : '-', color: 'var(--neutral)' },
      { label: 'BB Lower (20,2)', value: bb ? formatINR(bb.lower) : '-', color: 'var(--neutral)' },

      { label: 'Supertrend', value: supertrend ? `${supertrend.trend.toUpperCase()} @ ${formatINR(supertrend.value)}` : '-', color: supertrend ? (supertrend.trend === 'bullish' ? 'var(--good)' : 'var(--bad)') : 'var(--neutral)' },

      { label: 'VWAP (20)', value: vwap ? formatINR(vwap) : '-', color: (vwap && price) ? (price > vwap ? 'var(--good)' : 'var(--bad)') : 'var(--neutral)' },

      { label: 'ATR (14)', value: atr ? formatINR(atr) : '-', color: atr ? (atr/price > 0.03 ? 'var(--bad)' : 'var(--neutral)') : 'var(--neutral)' }
    ];

    indFull.forEach(ind => {
      const div = document.createElement('div');
      div.className = 'ind-item';
      div.innerHTML = `
        <div class="ind-label">${ind.label}</div>
        <div class="ind-value" style="color:${ind.color}">${ind.value}</div>
        ${ind.note ? `<div class="ind-note">${ind.note}</div>` : ''}
      `;
      ig.appendChild(div);
    });

    document.getElementById('volumeAnalysis').textContent = volumeData ? `Current: ${volumeData.currentVolume} ‚Ä¢ Avg: ${Math.round(volumeData.avgVolume)} ‚Ä¢ ${volumeData.volumeTrend}` : '-';
    document.getElementById('weeklyAnalysis').textContent = weeklyBull === null ? '-' : (weeklyBull ? 'Weekly trend bullish' : 'Weekly trend bearish');

    document.getElementById('outputArea').style.display = 'grid';
    setStatus('Analysis complete');

    // Render Signal Breakdown (Bullish / Bearish / Neutral) exactly
    const bull = signals.filter(s => s.type === 'bullish');
    const bear = signals.filter(s => s.type === 'bearish');
    const neu  = signals.filter(s => s.type === 'neutral');

    document.getElementById('signalBreakdown').innerHTML = `
      <div style="margin-bottom:8px"><strong style="color:var(--good)">Bullish Signals (${bull.length})</strong></div>
      ${bull.length ? bull.map(x => `‚Ä¢ ${x.text}`).join('<br>') : '<div style="color:#6b7280">None</div>'}
      <hr style="margin:8px 0;border:none;border-top:1px solid #e6eef8" />
      <div style="margin-bottom:8px"><strong style="color:var(--bad)">Bearish Signals (${bear.length})</strong></div>
      ${bear.length ? bear.map(x => `‚Ä¢ ${x.text}`).join('<br>') : '<div style="color:#6b7280">None</div>'}
      <hr style="margin:8px 0;border:none;border-top:1px solid #e6eef8" />
      <div style="margin-bottom:8px"><strong style="color:var(--neutral)">Neutral Signals (${neu.length})</strong></div>
      ${neu.length ? neu.map(x => `‚Ä¢ ${x.text}`).join('<br>') : '<div style="color:#6b7280">None</div>'}
    `;

    // save to history
    addHistoryRecord(symbolRaw, { price, score, decision: decisionLabel });

  } catch(e){
    console.error(e);
    alert('Analysis failed: ' + e.message);
    setStatus('Error');
  } finally {
    analyzeBtn.classList.remove('analyzing');
    analyzeBtn.disabled = false;
  }
}

/* ---------------------------
   Export current analysis to PDF (keeps existing layout)
   --------------------------- */
async function exportCurrentToPDF(){
  if(document.getElementById('outputArea').style.display === 'none'){ alert('Run an analysis first'); return; }
  const clone = document.createElement('div');
  clone.style.width='900px'; clone.style.background='#fff'; clone.style.padding='18px'; clone.style.color='#071026';
  clone.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><h2 style="margin:0">Enhanced Swing Analyzer v12.1</h2><div style="font-size:12px;color:#333;margin-top:6px">Curated By - BIPLAB BAWALI</div></div><div style="text-align:right;font-size:12px;color:#333">${document.getElementById('outTicker').textContent || ''}<br>${new Date().toLocaleString()}</div></div><hr style="margin:12px 0;border:none;border-top:1px solid #eee" /><div id="pdfBody"></div><hr style="margin:12px 0;border:none;border-top:1px solid #eee" /><div style="font-size:11px;color:#666">Curated By - BIPLAB BAWALI ‚Ä¢ Enhanced Swing Analyzer v12.1</div>`;
  const pdfBody = clone.querySelector('#pdfBody');
  pdfBody.innerHTML = `<h3>Summary</h3><div><strong>Price:</strong> ${document.getElementById('outPrice').textContent}</div><div><strong>Decision:</strong> ${document.getElementById('decisionBadge').textContent}</div><div><strong>Score:</strong> ${document.getElementById('scoreFill').textContent}</div><h3 style="margin-top:12px">Pattern Analysis</h3><div style="background:#f7f9fc;padding:8px;border-radius:6px">${document.getElementById('patternAnalysis').innerHTML}</div><h3 style="margin-top:12px">Smart Advice</h3><div style="background:#f0fdf4;padding:8px;border-radius:6px">${document.getElementById('smartAdvice').innerHTML}</div>`;
  document.body.appendChild(clone);
  try{
    const canvas = await html2canvas(clone, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
    const imgData = canvas.toDataURL('image/jpeg', 0.95);
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({ unit:'pt', format:'a4' });
    const pageWidth = pdf.internal.pageSize.getWidth();
    const imgWidth = pageWidth - 40;
    const imgHeight = canvas.height * imgWidth / canvas.width;
    pdf.addImage(imgData, 'JPEG', 20, 20, imgWidth, imgHeight);
    const filename = `${document.getElementById('outTicker').textContent.replace(/\s+/g,'_')}_Analysis_${new Date().toISOString().slice(0,10)}.pdf`;
    pdf.save(filename);
  }catch(e){ console.error(e); alert('PDF export failed: ' + e.message); } finally { clone.remove(); }
}
</script>
</body>
</html>
